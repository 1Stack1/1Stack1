<!DOCTYPE html>
<html lang="en">
	<head>
		
<title>lottery.md - 1Stack1</title>
<meta charset="utf-8" />
<meta name="keywords" content="" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=5"
/>
<meta name="generator" content="Hexo 7.1.1">
<link rel="stylesheet" href="/css/style.css?v=1710592518624">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap"
    media="all"
/>
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/solarized-light.css"
/>
<script src="/js/core.js?v=1710592518624"></script>






<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js" async></script>
<!--<script src="" async></script>--> 
	</head>

	<body>
        <div class="header  ">
    <div class="container">
        <a class="logo" href="/" title="1Stack1">1Stack1</a>
        <ul class="nav">
            
                <li class="nav-item"><a href="/archives">Archives</a></li>
            
                <li class="nav-item"><a href="/about.html">About</a></li>
            
        </ul>
    </div>
</div>
        <div class="content">
	<div class="banner">
		<div class="container">
			<h1>lottery.md</h1>
			<div class="info"><span class="date">2024年3月11日</span>•1Stack1 
			
					《<a class="nexmoefont icon-appstore-fill -link" href="/categories/note/">note</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/note/%E9%A1%B9%E7%9B%AE/">项目</a>》
				
				
					<a href="https://github.com/nexmoe/books/tree/master/source/_posts/项目/lottery.md" target="_blank" rel="external nofollow noreferrer noopener">编辑</a>
				
			</div>
			
		</div>
	</div>
	<div class="container">
		<article class="post">
			<h1 id="领域层"><a href="#领域层" class="headerlink" title="领域层"></a>领域层</h1><h2 id="抽奖领域"><a href="#抽奖领域" class="headerlink" title="抽奖领域"></a>抽奖领域</h2><h3 id="抽奖策略"><a href="#抽奖策略" class="headerlink" title="抽奖策略"></a>抽奖策略</h3><p>使用策略模式</p>
<p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/IDrawAlgorithm.png" alt="IDrawAlgorithm"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IDrawAlgorithm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序启动时初始化概率元祖，在初始化完成后使用过程中不允许修改元祖数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initRateTuple</span><span class="params">(Long strategyId,Integer strategyMode, List&lt;AwardRateInfo&gt; awardRateInfoList)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否已经，做了数据初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isExist</span><span class="params">(Long strategyId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SecureRandom 生成随机数，索引到对应的奖品信息返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">randomDraw</span><span class="params">(Long strategyId, List&lt;String&gt; excludeAwardIds)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseAlgorithm</span> <span class="keyword">implements</span> <span class="title class_">IDrawAlgorithm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 斐波那契散列增量，逻辑：黄金分割点：(√5 - 1) / 2 = 0.6180339887，Math.pow(2, 32) * 0.6180339887 = 0x61c88647</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数组初始化长度 128，保证数据填充时不发生碰撞的最小初始化值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RATE_TUPLE_LENGTH</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存放概率与奖品对应的散列结果，strategyId -&gt; rateTuple</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Long, String[]&gt; rateTupleMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 奖品区间概率值，strategyId -&gt; [awardId-&gt;begin、awardId-&gt;end]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Long, List&lt;AwardRateInfo&gt;&gt; awardRateInfoMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">initRateTuple</span><span class="params">(Long strategyId, Integer strategyMode, List&lt;AwardRateInfo&gt; awardRateInfoList)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前置判断</span></span><br><span class="line">        <span class="keyword">if</span> (isExist(strategyId))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存奖品概率信息</span></span><br><span class="line">        awardRateInfoMap.put(strategyId, awardRateInfoList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非单项概率，不必存入缓存，因为这部分抽奖算法需要实时处理中奖概率。</span></span><br><span class="line">        <span class="keyword">if</span> (!Constants.StrategyMode.SINGLE.getCode().equals(strategyMode)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] rateTuple = rateTupleMap.computeIfAbsent(strategyId, k -&gt; <span class="keyword">new</span> <span class="title class_">String</span>[RATE_TUPLE_LENGTH]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        通过斐波那契散列法来填充rateTuple</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isExist</span><span class="params">(Long strategyId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> awardRateInfoMap.containsKey(strategyId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 斐波那契（Fibonacci）散列法，计算哈希索引下标值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashIdx</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> val * HASH_INCREMENT + HASH_INCREMENT;</span><br><span class="line">        <span class="keyword">return</span> hashCode &amp; (RATE_TUPLE_LENGTH - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成百位随机抽奖码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 随机值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">generateSecureRandomIntCode</span><span class="params">(<span class="type">int</span> bound)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecureRandom</span>().nextInt(bound) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;singleRateRandomDrawAlgorithm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingleRateRandomDrawAlgorithm</span> <span class="keyword">extends</span> <span class="title class_">BaseAlgorithm</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">randomDraw</span><span class="params">(Long strategyId, List&lt;String&gt; excludeAwardIds)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取策略对应的元祖</span></span><br><span class="line">        String[] rateTuple = <span class="built_in">super</span>.rateTupleMap.get(strategyId);</span><br><span class="line">        <span class="keyword">assert</span> rateTuple != <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机索引</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">randomVal</span> <span class="operator">=</span> <span class="built_in">this</span>.generateSecureRandomIntCode(<span class="number">100</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="built_in">super</span>.hashIdx(randomVal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">awardId</span> <span class="operator">=</span> rateTuple[idx];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果中奖ID命中排除奖品列表，则返回NULL</span></span><br><span class="line">        <span class="keyword">if</span> (excludeAwardIds.contains(awardId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> awardId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;entiretyRateRandomDrawAlgorithm&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EntiretyRateRandomDrawAlgorithm</span> <span class="keyword">extends</span> <span class="title class_">BaseAlgorithm</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">randomDraw</span><span class="params">(Long strategyId, List&lt;String&gt; excludeAwardIds)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">differenceDenominator</span> <span class="operator">=</span> BigDecimal.ZERO;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排除掉不在抽奖范围的奖品ID集合</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        	根据父类的awardRateInfoMap以及参数excludeAwardIds获得在抽奖范围的奖品differenceAwardRateList，及其概率和differenceDenominator</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前置判断：奖品列表为0，返回NULL</span></span><br><span class="line">        <span class="keyword">if</span> (differenceAwardRateList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前置判断：奖品列表为1，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (differenceAwardRateList.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> differenceAwardRateList.get(<span class="number">0</span>).getAwardId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取随机概率值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">randomVal</span> <span class="operator">=</span> <span class="built_in">this</span>.generateSecureRandomIntCode(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环获取奖品</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        通过新的概率分布*100与随机数使用累和概率法来抽奖</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回中奖结果</span></span><br><span class="line">        <span class="keyword">return</span> awardId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>简单抽奖算法为什么要使用斐波那契散列法</p>
</blockquote>
<p>1.该开始使用hashmap</p>
<p>​	eg:[a:0.2,b:0.3,c:0.5]，计算时遍历entry数组，进行累加，当大于等于random时抽奖，时间复杂度O(n)。也会有hash冲突。</p>
<p>2.累和数组</p>
<p>​	eg:[0.2,0.5,1]，当使用二分查找时时间复杂度O(logn)。</p>
<p>3.一般hashMap查找都是O(1)复杂度，改变key-&gt;value映射关系，将查询时间复杂度优化为O(1)</p>
<p>​	eg:[0:a,1:a,….,20:b,21:b,…],时间复杂度O(1),但会有</p>
<p>4.上面hashMap存在hash冲突情况，根据上面key从0~100的映射，可以再优化为数组</p>
<p>​	eg:[a,a,a,…,b,b,b,…],时间复杂度O(1),但如果概率和不为100，并不能很好的体现散列的均匀性（可能有其他原因，需要再查找资料）</p>
<p>5.借鉴ThreadLocal的斐波那契散列，来将数组的散列算法进行优化</p>
<p>​	时间复杂度O(1)</p>
<h3 id="抽奖流程"><a href="#抽奖流程" class="headerlink" title="抽奖流程"></a>抽奖流程</h3><p>使用模板模式，在<strong>AbstractDrawBase</strong>中编排抽奖流程，在<strong>DrawExecImpl</strong>中执行具体每一步的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DrawResult <span class="title function_">doDrawExec</span><span class="params">(DrawReq req)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 获取抽奖策略</span></span><br><span class="line">    <span class="comment">//StrategyRich包含策略id、策略信息、策略详细信息</span></span><br><span class="line">    <span class="type">StrategyRich</span> <span class="variable">strategyRich</span> <span class="operator">=</span> <span class="built_in">super</span>.queryStrategyRich(req.getStrategyId());</span><br><span class="line">    <span class="type">StrategyBriefVO</span> <span class="variable">strategy</span> <span class="operator">=</span> strategyRich.getStrategy();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 校验抽奖策略是否已经初始化到内存</span></span><br><span class="line">    <span class="comment">//实际时通过对应抽奖策略的isExist()判断是否初始化和initRateTuple()进行初始化</span></span><br><span class="line">    <span class="built_in">this</span>.checkAndInitRateData(req.getStrategyId(), strategy.getStrategyMode(), strategyRich.getStrategyDetailList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 获取不在抽奖范围内的列表，包括：奖品库存为空、风控策略、临时调整等</span></span><br><span class="line">    <span class="comment">//由子类实现，实际是通过查询strategy_detail表，查询条件是strategy_id为提供的strategyId and award_surplus_count为0</span></span><br><span class="line">    List&lt;String&gt; excludeAwardIds = <span class="built_in">this</span>.queryExcludeAwardIds(req.getStrategyId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行抽奖算法</span></span><br><span class="line">    <span class="comment">//由子类实现，实际是通过对应抽奖策略的randomDraw(),当抽到奖后通过更新strategy_detail使得award_surplus_count自减，更新条件strategy_id = #&#123;strategyId&#125; AND award_id = #&#123;awardId&#125; AND award_surplus_count &gt; 0</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">awardId</span> <span class="operator">=</span> <span class="built_in">this</span>.drawAlgorithm(req.getStrategyId(), drawAlgorithmGroup.get(strategy.getStrategyMode()), excludeAwardIds);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 包装中奖结果</span></span><br><span class="line">    <span class="keyword">return</span> buildDrawResult(req.getuId(), req.getStrategyId(), awardId, strategy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发奖领域"><a href="#发奖领域" class="headerlink" title="发奖领域"></a>发奖领域</h2><p>使用工厂模式</p>
<p>发奖奖品</p>
<p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/IDistributionGoods.png" alt="IDistributionGoods"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DistributionRes <span class="title function_">doDistribution</span><span class="params">(GoodsReq req)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 模拟调用优惠券发放接口</span></span><br><span class="line">    logger.info(<span class="string">&quot;模拟调用优惠券发放接口 uId：&#123;&#125; awardContent：&#123;&#125;&quot;</span>, req.getuId(), req.getAwardContent());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.更新用户领奖结果</span></span><br><span class="line">    <span class="comment">//实际是修改user_strategy_export表使得发奖状态变为（完成），修改条件u_id = #&#123;uId&#125; AND order_id = #&#123;orderId&#125; AND award_id = #&#123;awardId&#125;</span></span><br><span class="line">    <span class="built_in">super</span>.updateUserAwardState(req.getuId(), req.getOrderId(), req.getAwardId(), Constants.GrantState.COMPLETE.getCode());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DistributionRes</span>(req.getuId(), Constants.AwardState.SUCCESS.getCode(), Constants.AwardState.SUCCESS.getInfo());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工厂类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 奖品发放策略组 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Map&lt;Integer, IDistributionGoods&gt; goodsMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DescGoods descGoods;<span class="comment">//描述类商品，以文字形式展示给用户</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedeemCodeGoods redeemCodeGoods;<span class="comment">//兑换码类商品</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CouponGoods couponGoods;<span class="comment">//优惠券商品</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PhysicalGoods physicalGoods;<span class="comment">//实物类奖品</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        goodsMap.put(Constants.AwardType.DESC.getCode(), descGoods);</span><br><span class="line">        goodsMap.put(Constants.AwardType.RedeemCodeGoods.getCode(), redeemCodeGoods);</span><br><span class="line">        goodsMap.put(Constants.AwardType.CouponGoods.getCode(), couponGoods);</span><br><span class="line">        goodsMap.put(Constants.AwardType.PhysicalGoods.getCode(), physicalGoods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributionGoodsFactory</span> <span class="keyword">extends</span> <span class="title class_">GoodsConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IDistributionGoods <span class="title function_">getDistributionGoodsService</span><span class="params">(Integer awardTye)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> goodsMap.get(awardTye);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="活动领域"><a href="#活动领域" class="headerlink" title="活动领域"></a>活动领域</h2><h3 id="状态流转"><a href="#状态流转" class="headerlink" title="状态流转"></a>状态流转</h3><p>使用状态模式</p>
<p>状态流转图</p>
<p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/image-20230413132358735.png" alt="image-20230413132358735"></p>
<p>活动状态</p>
<p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/AbstractState.png" alt="AbstractState"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span>  <span class="keyword">class</span> <span class="title class_">AbstractState</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> IActivityRepository activityRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动提审</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">arraignment</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核通过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">checkPass</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核拒绝</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">checkRefuse</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 撤审撤销</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">checkRevoke</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">close</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动开启</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">open</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 活动执行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title function_">doing</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> eg：提审状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArraignmentState</span> <span class="keyword">extends</span> <span class="title class_">AbstractState</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">arraignment</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.buildResult(Constants.ResponseCode.UNKNOWN_ERROR, <span class="string">&quot;待审核状态不可重复提审&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkPass</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentState)</span> &#123;</span><br><span class="line">        <span class="comment">//实际是修改activity表使得state变为需要的状态，修改条件是activity_id = #&#123;activityId&#125; AND state = #&#123;beforeState&#125;</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> activityRepository.alterStatus(activityId, currentState, Constants.ActivityState.PASS);</span><br><span class="line">        <span class="keyword">return</span> isSuccess ? Result.buildResult(Constants.ResponseCode.SUCCESS, <span class="string">&quot;活动审核通过完成&quot;</span>) : Result.buildErrorResult(<span class="string">&quot;活动状态变更失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>活动状态处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IStateHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提审</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Result <span class="title function_">arraignment</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核通过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Result <span class="title function_">checkPass</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentStatus)</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StateHandlerImpl</span> <span class="keyword">extends</span> <span class="title class_">StateConfig</span> <span class="keyword">implements</span> <span class="title class_">IStateHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">arraignment</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="comment">//实际是调用currentStatus对应状态类的对应方法来实现状态流转</span></span><br><span class="line">        <span class="keyword">return</span> stateGroup.get(currentStatus).arraignment(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">checkPass</span><span class="params">(Long activityId, Enum&lt;Constants.ActivityState&gt; currentStatus)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stateGroup.get(currentStatus).checkPass(activityId, currentStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="活动参与"><a href="#活动参与" class="headerlink" title="活动参与"></a>活动参与</h3><p>使用模板模式</p>
<p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/ActivityPartakeImpl.png" alt="ActivityPartakeImpl"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IActivityPartake</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参与活动</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PartakeResult <span class="title function_">doPartake</span><span class="params">(PartakeReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存奖品单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Result <span class="title function_">recordDrawOrder</span><span class="params">(DrawOrderVO drawOrder)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新发货单MQ状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateInvoiceMqState</span><span class="params">(String uId, Long orderId, Integer mqState)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描发货单 MQ 状态，把未发送 MQ 的单子扫描出来，做补偿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;InvoiceVO&gt; <span class="title function_">scanInvoiceMqState</span><span class="params">(<span class="type">int</span> dbCount, <span class="type">int</span> i)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span>  <span class="title class_">BaseActivityPartake</span> <span class="keyword">extends</span> <span class="title class_">ActivityPartakeSupport</span> <span class="keyword">implements</span>  <span class="title class_">IActivityPartake</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Constants.Ids, IIdGenerator&gt; idGeneratorMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PartakeResult <span class="title function_">doPartake</span><span class="params">(PartakeReq req)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查询是否存在未执行抽奖领取活动单【user_take_activity 存在 state = 0，领取了但抽奖过程失败的，可以直接返回领取结果继续抽奖】</span></span><br><span class="line">        <span class="comment">//由子类实现，实际是查询user_take_activity，查询条件为u_id = #&#123;uId&#125; AND activity_id = #&#123;activityId&#125; AND state = 0 ORDER BY id DESC LIMIT 1</span></span><br><span class="line">        <span class="type">UserTakeActivityVO</span> <span class="variable">userTakeActivityVO</span> <span class="operator">=</span> <span class="built_in">this</span>.queryNoConsumedTakeActivityOrder(req.getActivityId(), req.getuId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != userTakeActivityVO) &#123;</span><br><span class="line">            <span class="keyword">return</span> buildPartakeResult(userTakeActivityVO.getStrategyId(), userTakeActivityVO.getTakeId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查询活动账单</span></span><br><span class="line">        <span class="comment">//实际是查询activity表，通过activity_id查询；以及通过u_id和activity_id查询user_take_activity_count。以获取activity信息以及剩余领取次数</span></span><br><span class="line">        <span class="type">ActivityBillVO</span> <span class="variable">activityBillVO</span> <span class="operator">=</span> <span class="built_in">super</span>.queryActivityBill(req);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 活动信息校验处理</span></span><br><span class="line">        <span class="comment">//由子类实现，实际是校验【活动库存、状态、日期、剩余参与次数】</span></span><br><span class="line">        <span class="type">Result</span> <span class="variable">checkResult</span> <span class="operator">=</span> <span class="built_in">this</span>.checkActivityBill(req, activityBillVO);</span><br><span class="line">        <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(checkResult.getCode())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PartakeResult</span>(checkResult.getCode(), checkResult.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 扣减活动库存【目前为直接对配置库中的 lottery.activity 直接操作表扣减库存，后续优化为Redis扣减】</span></span><br><span class="line">        <span class="comment">//实际是更新activity使得stock_surplus_coun--,更新条件activity_id = #&#123;activityId&#125; AND stock_surplus_count &gt; 0</span></span><br><span class="line">        <span class="type">Result</span> <span class="variable">subtractionActivityResult</span> <span class="operator">=</span> <span class="built_in">this</span>.subtractionActivityStock(req);</span><br><span class="line">        <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(subtractionActivityResult.getCode())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PartakeResult</span>(subtractionActivityResult.getCode(), subtractionActivityResult.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 插入领取活动信息【个人用户把活动信息写入到用户表】</span></span><br><span class="line">        <span class="comment">//活动参与id-&gt;雪花算法</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">takeId</span> <span class="operator">=</span> idGeneratorMap.get(Constants.Ids.SnowFlake).nextId();</span><br><span class="line">        <span class="comment">//由子类实现，在一个事务里，实际是去user_take_activity_count更新left_count--,更新条件u_id = #&#123;uId&#125; AND activity_id = #&#123;activityId&#125; AND left_count &gt; 0，目的是更新个人剩余参与次数；去user_take_activity新增一条用户参与记录，其中take_count为activity.take_count - user_take_left_count、防重id-uuid为uId + &quot;_&quot; + activityId + &quot;_&quot; + userTakeActivity.getTakeCount();</span></span><br><span class="line">        <span class="type">Result</span> <span class="variable">grabResult</span> <span class="operator">=</span> <span class="built_in">this</span>.grabActivity(req, activityBillVO, takeId);</span><br><span class="line">        <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(grabResult.getCode())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PartakeResult</span>(grabResult.getCode(), grabResult.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buildPartakeResult(activityBillVO.getStrategyId(), takeId);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h2 id="规则引擎领域"><a href="#规则引擎领域" class="headerlink" title="规则引擎领域"></a>规则引擎领域</h2><p>组合模式</p>
<p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/image-20230418123945108.png" alt="image-20230418123945108"></p>
<p>表设计</p>
<p><strong>rule_tree</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `rule_tree` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `tree_name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则树NAME&#x27;</span>,</span><br><span class="line">  `tree_desc` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则树描述&#x27;</span>,</span><br><span class="line">  `tree_root_node_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则树根ID&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">10002</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>rule_tree_node</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `rule_tree_node` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `tree_id` <span class="type">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则树ID&#x27;</span>,</span><br><span class="line">  `node_type` <span class="type">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;节点类型；1子叶、2果实&#x27;</span>,</span><br><span class="line">  `node_value` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;节点值[nodeType=2]；果实值&#x27;</span>,</span><br><span class="line">  `rule_key` <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则Key&#x27;</span>,</span><br><span class="line">  `rule_desc` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则描述&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">123</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>rule_tree_node_line</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `rule_tree_node_line` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键ID&#x27;</span>,</span><br><span class="line">  `tree_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;规则树ID&#x27;</span>,</span><br><span class="line">  `node_id_from` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;节点From&#x27;</span>,</span><br><span class="line">  `node_id_to` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;节点To&#x27;</span>,</span><br><span class="line">  `rule_limit_type` <span class="type">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;限定类型；1:=;2:&gt;;3:&lt;;4:&gt;=;5&lt;=;6:enum[枚举范围];7:果实&#x27;</span>,</span><br><span class="line">  `rule_limit_value` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;限定值&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">7</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>为什么要让逻辑过滤器和规则过滤器分开实现</p>
</blockquote>
<p>规则过滤器是根据treeId和入参，来实现从根节点到叶子节点的整体流程。规则过滤器就相当于实现整体流程中的每一个具体过程，而且其中树的遍历（层序）难免会涉及到不同种的过滤规则，需要实现“逻辑过滤”接口来定制化不同的规则过滤器。</p>
<h3 id="逻辑过滤"><a href="#逻辑过滤" class="headerlink" title="逻辑过滤"></a>逻辑过滤</h3><p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/LogicFilter.png" alt="LogicFilter"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LogicFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 逻辑决策器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> matterValue          决策值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> treeNodeLineInfoList 决策节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>                     下一个节点Id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Long <span class="title function_">filter</span><span class="params">(String matterValue, List&lt;TreeNodeLineVO&gt; treeNodeLineInfoList)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取决策值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> decisionMatter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">matterValue</span><span class="params">(DecisionMatterReq decisionMatter)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseLogic</span> <span class="keyword">implements</span> <span class="title class_">LogicFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">filter</span><span class="params">(String matterValue, List&lt;TreeNodeLineVO&gt; treeNodeLineInfoList)</span> &#123;</span><br><span class="line">        <span class="comment">//遍历treeNodeLine（其实就是以当前节点为起点的树径），根据他们的决策规则，选择下一步的树节点id</span></span><br><span class="line">        <span class="keyword">for</span>(TreeNodeLineVO nodeLine : treeNodeLineInfoList)&#123;</span><br><span class="line">            <span class="keyword">if</span>(decisionLogic(matterValue, nodeLine))&#123;</span><br><span class="line">                <span class="keyword">return</span> nodeLine.getNodeIdTo();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Constants.Global.TREE_NULL_NODE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取规则比对值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">abstract</span> String <span class="title function_">matterValue</span><span class="params">(DecisionMatterReq decisionMatter)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *根据决策值和树径选择是否走该树径</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span>  <span class="title function_">decisionLogic</span><span class="params">(String matterValue, TreeNodeLineVO nodeLine)</span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (nodeLine.getRuleLimitType())&#123;</span><br><span class="line">            <span class="keyword">case</span> Constants.RuleLimitType.EQUAL:</span><br><span class="line">                <span class="keyword">return</span> matterValue.equals(nodeLine.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> Constants.RuleLimitType.GT:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &gt; Double.parseDouble(nodeLine.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> Constants.RuleLimitType.LT:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &lt; Double.parseDouble(nodeLine.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> Constants.RuleLimitType.GE:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &gt;= Double.parseDouble(nodeLine.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">case</span> Constants.RuleLimitType.LE:</span><br><span class="line">                <span class="keyword">return</span> Double.parseDouble(matterValue) &lt;= Double.parseDouble(nodeLine.getRuleLimitValue());</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*年龄逻辑过滤器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAgeFilter</span> <span class="keyword">extends</span> <span class="title class_">BaseLogic</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">matterValue</span><span class="params">(DecisionMatterReq decisionMatter)</span> &#123;</span><br><span class="line">        <span class="comment">//实际上获取根据规则引擎传递的参数（接口传递的参数）中的值</span></span><br><span class="line">        <span class="comment">//eg:&#123;age:10,gender:man&#125;获取age对应的值。</span></span><br><span class="line">        <span class="keyword">return</span> decisionMatter.getValMap().get(<span class="string">&quot;age&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*性别逻辑过滤器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserGenderFilter</span> <span class="keyword">extends</span> <span class="title class_">BaseLogic</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">matterValue</span><span class="params">(DecisionMatterReq decisionMatter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> decisionMatter.getValMap().get(<span class="string">&quot;gender&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="规则引擎"><a href="#规则引擎" class="headerlink" title="规则引擎"></a>规则引擎</h3><p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/RuleEngineHandle.png" alt="RuleEngineHandle"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EngineFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规则过滤器接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    EngineResult <span class="title function_">process</span><span class="params">(<span class="keyword">final</span> DecisionMatterReq matter)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">EngineBase</span> <span class="keyword">extends</span> <span class="title class_">EngineConfig</span> <span class="keyword">implements</span> <span class="title class_">EngineFilter</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//由子类去实现</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EngineResult <span class="title function_">process</span><span class="params">(DecisionMatterReq matter)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;未实现规则引擎服务&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *子类调用该方法，用于根据逻辑过滤器去寻找最终的叶子节点</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> TreeNodeVO <span class="title function_">engineDecisionMaker</span><span class="params">(TreeRuleRich treeRuleRich, DecisionMatterReq matter)</span> &#123;</span><br><span class="line">        <span class="type">TreeRootVO</span> <span class="variable">treeRoot</span> <span class="operator">=</span> treeRuleRich.getTreeRoot();</span><br><span class="line">        Map&lt;Long, TreeNodeVO&gt; treeNodeMap = treeRuleRich.getTreeNodeMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规则树根ID</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">rootNodeId</span> <span class="operator">=</span> treeRoot.getTreeRootNodeId();</span><br><span class="line">        <span class="type">TreeNodeVO</span> <span class="variable">treeNodeInfo</span> <span class="operator">=</span> treeNodeMap.get(rootNodeId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点类型[NodeType]；1子叶、2果实</span></span><br><span class="line">        <span class="keyword">while</span> (Constants.NodeType.STEM.equals(treeNodeInfo.getNodeType())) &#123;</span><br><span class="line">            <span class="comment">//获取当前节点(不断遍历更新)规则</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">ruleKey</span> <span class="operator">=</span> treeNodeInfo.getRuleKey();</span><br><span class="line">            <span class="comment">//获取对应逻辑过滤器</span></span><br><span class="line">            <span class="type">LogicFilter</span> <span class="variable">logicFilter</span> <span class="operator">=</span> logicFilterMap.get(ruleKey);<span class="comment">//logicFilterMap在EngineConfig中初始化，规则与逻辑过滤器映射</span></span><br><span class="line">            <span class="comment">//获取决策值，实际入参matter里传递的值，eg:matter里保存了&#123;age:10,gender:man&#125;，如果是年龄过滤器就是获取age对应的值</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">matterValue</span> <span class="operator">=</span> logicFilter.matterValue(matter);</span><br><span class="line">            <span class="comment">//获取下一个节点id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">nextNode</span> <span class="operator">=</span> logicFilter.filter(matterValue, treeNodeInfo.getTreeNodeLineInfoList());</span><br><span class="line">            <span class="comment">//获取下一个节点</span></span><br><span class="line">            treeNodeInfo = treeNodeMap.get(nextNode);</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;决策树引擎=&gt;&#123;&#125; userId：&#123;&#125; treeId：&#123;&#125; treeNode：&#123;&#125; ruleKey：&#123;&#125; matterValue：&#123;&#125;&quot;</span>,</span><br><span class="line">                    treeRoot.getTreeName(), matter.getUserId(), matter.getTreeId(), treeNodeInfo.getTreeNodeId(), ruleKey, matterValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> treeNodeInfo;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuleEngineHandle</span> <span class="keyword">extends</span> <span class="title class_">EngineBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IRuleRepository ruleRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EngineResult <span class="title function_">process</span><span class="params">(DecisionMatterReq matter)</span> &#123;</span><br><span class="line">        <span class="comment">// 决策规则树</span></span><br><span class="line">        <span class="type">TreeRuleRich</span> <span class="variable">treeRuleRich</span> <span class="operator">=</span> ruleRepository.queryTreeRuleRich(matter.getTreeId());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == treeRuleRich) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Tree Rule is null!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 决策节点</span></span><br><span class="line">        <span class="type">TreeNodeVO</span> <span class="variable">treeNodeInfo</span> <span class="operator">=</span> engineDecisionMaker(treeRuleRich, matter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 决策结果</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EngineResult</span>(matter.getUserId(), treeNodeInfo.getTreeId(), treeNodeInfo.getTreeNodeId(), treeNodeInfo.getNodeValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h1><h2 id="抽奖过程"><a href="#抽奖过程" class="headerlink" title="抽奖过程"></a>抽奖过程</h2><p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/image-20230416121407965.png" alt="image-20230416121407965"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IActivityProcess</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行抽奖流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DrawProcessResult <span class="title function_">doDrawProcess</span><span class="params">(DrawProcessReq req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 规则量化人群，返回可参与的活动ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RuleQuantificationCrowdResult <span class="title function_">doRuleQuantificationCrowd</span><span class="params">(DecisionMatterReq req)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DrawProcessResult <span class="title function_">doDrawProcess</span><span class="params">(DrawProcessReq req)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 领取活动</span></span><br><span class="line">    <span class="type">PartakeResult</span> <span class="variable">partakeResult</span> <span class="operator">=</span> activityPartake.doPartake(<span class="keyword">new</span> <span class="title class_">PartakeReq</span>(req.getuId(), req.getActivityId()));</span><br><span class="line">    <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(partakeResult.getCode())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawProcessResult</span>(partakeResult.getCode(), partakeResult.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">strategyId</span> <span class="operator">=</span> partakeResult.getStrategyId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">takeId</span> <span class="operator">=</span> partakeResult.getTakeId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 执行抽奖</span></span><br><span class="line">    <span class="type">DrawResult</span> <span class="variable">drawResult</span> <span class="operator">=</span> drawExec.doDrawExec(<span class="keyword">new</span> <span class="title class_">DrawReq</span>(req.getuId(), strategyId));</span><br><span class="line">    <span class="keyword">if</span> (Constants.DrawState.FAIL.getCode().equals(drawResult.getDrawState())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawProcessResult</span>(Constants.ResponseCode.LOSING_DRAW.getCode(), Constants.ResponseCode.LOSING_DRAW.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">DrawAwardVO</span> <span class="variable">drawAwardVO</span> <span class="operator">=</span> drawResult.getDrawAwardInfo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 结果落库</span></span><br><span class="line">    <span class="type">DrawOrderVO</span> <span class="variable">drawOrderVO</span> <span class="operator">=</span> buildDrawOrderVO(req, strategyId, takeId, drawAwardVO);</span><br><span class="line">    <span class="type">Result</span> <span class="variable">recordResult</span> <span class="operator">=</span> activityPartake.recordDrawOrder(drawOrderVO);</span><br><span class="line">    <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(recordResult.getCode())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawProcessResult</span>(recordResult.getCode(), recordResult.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 发送MQ，触发发奖流程</span></span><br><span class="line">    <span class="type">InvoiceVO</span> <span class="variable">invoiceVO</span> <span class="operator">=</span> buildInvoiceVO(drawOrderVO);</span><br><span class="line">    ListenableFuture&lt;SendResult&lt;String, Object&gt;&gt; future = kafkaProducer.sendLotteryInvoice(invoiceVO);</span><br><span class="line">    future.addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;SendResult&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult&lt;String, Object&gt; stringObjectSendResult)</span> &#123;</span><br><span class="line">            <span class="comment">// 4.1 MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span></span><br><span class="line">            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            <span class="comment">// 4.2 MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span></span><br><span class="line">            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawProcessResult</span>(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo(), drawAwardVO);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RuleQuantificationCrowdResult <span class="title function_">doRuleQuantificationCrowd</span><span class="params">(DecisionMatterReq req)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 量化决策</span></span><br><span class="line">    <span class="type">EngineResult</span> <span class="variable">engineResult</span> <span class="operator">=</span> engineFilter.process(req);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!engineResult.isSuccess())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleQuantificationCrowdResult</span>(Constants.ResponseCode.RULE_ERR.getCode(),Constants.ResponseCode.RULE_ERR.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. 封装结果</span></span><br><span class="line">    <span class="type">RuleQuantificationCrowdResult</span> <span class="variable">ruleQuantificationCrowdResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleQuantificationCrowdResult</span>(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo());</span><br><span class="line">    ruleQuantificationCrowdResult.setActivityId(Long.valueOf(engineResult.getNodeValue()));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ruleQuantificationCrowdResult;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LotteryActivityBooth</span> <span class="keyword">implements</span> <span class="title class_">ILotteryActivityBooth</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IActivityProcess activityProcess;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMapping&lt;DrawAwardVO, AwardDTO&gt; awardMapping;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DrawRes <span class="title function_">doDraw</span><span class="params">(DrawReq drawReq)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           log.info(<span class="string">&quot;抽奖，开始 uId：&#123;&#125; activityId：&#123;&#125;&quot;</span>, drawReq.getUId(), drawReq.getActivityId());</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 1. 执行抽奖</span></span><br><span class="line">           <span class="type">DrawProcessResult</span> <span class="variable">drawProcessResult</span> <span class="operator">=</span> activityProcess.doDrawProcess(<span class="keyword">new</span> <span class="title class_">DrawProcessReq</span>(drawReq.getUId(), drawReq.getActivityId()));</span><br><span class="line">           <span class="keyword">if</span>(!Constants.ResponseCode.SUCCESS.getCode().equals(drawProcessResult.getCode()))&#123;</span><br><span class="line">               log.error(<span class="string">&quot;抽奖，失败(抽奖过程异常) uId：&#123;&#125; activityId：&#123;&#125;&quot;</span>, drawReq.getUId(), drawReq.getActivityId());</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawRes</span>(drawProcessResult.getCode(), drawProcessResult.getInfo());</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">return</span> drawRes;</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// TODO 量化人群抽奖细节</span></span><br><span class="line">    <span class="keyword">public</span> DrawRes <span class="title function_">doQuantificationDraw</span><span class="params">(QuantificationDrawReq quantificationDrawReq)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;量化人群抽奖，开始 uId：&#123;&#125; treeId：&#123;&#125;&quot;</span>, quantificationDrawReq.getuId(), quantificationDrawReq.getTreeId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 执行规则引擎，获取用户可以参与的活动号</span></span><br><span class="line">            <span class="type">RuleQuantificationCrowdResult</span> <span class="variable">ruleQuantificationCrowdResult</span> <span class="operator">=</span> activityProcess.doRuleQuantificationCrowd(<span class="keyword">new</span> <span class="title class_">DecisionMatterReq</span>(quantificationDrawReq.getuId(),</span><br><span class="line">                    quantificationDrawReq.getTreeId(), quantificationDrawReq.getValMap()));</span><br><span class="line">            <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(ruleQuantificationCrowdResult.getCode())) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;量化人群抽奖，失败(规则引擎执行异常) uId：&#123;&#125; treeId：&#123;&#125;&quot;</span>, quantificationDrawReq.getuId(), quantificationDrawReq.getTreeId());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawRes</span>(ruleQuantificationCrowdResult.getCode(), ruleQuantificationCrowdResult.getInfo());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 执行抽奖</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">activityId</span> <span class="operator">=</span> ruleQuantificationCrowdResult.getActivityId();</span><br><span class="line">            <span class="type">DrawProcessResult</span> <span class="variable">drawProcessResult</span> <span class="operator">=</span> activityProcess.doDrawProcess(<span class="keyword">new</span> <span class="title class_">DrawProcessReq</span>(quantificationDrawReq.getuId(), activityId));</span><br><span class="line">            <span class="keyword">if</span> (!Constants.ResponseCode.SUCCESS.getCode().equals(drawProcessResult.getCode())) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;量化人群抽奖，失败(抽奖过程异常) uId：&#123;&#125; treeId：&#123;&#125;&quot;</span>, quantificationDrawReq.getuId(), quantificationDrawReq.getTreeId());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawRes</span>(drawProcessResult.getCode(), drawProcessResult.getInfo());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;量化人群抽奖，完成 uId：&#123;&#125; treeId：&#123;&#125; drawRes：&#123;&#125;&quot;</span>, quantificationDrawReq.getuId(), quantificationDrawReq.getTreeId(), JSON.toJSONString(drawRes));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> drawRes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           	...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Kafka使用"><a href="#Kafka使用" class="headerlink" title="Kafka使用"></a>Kafka使用</h1><p><img src="/2024/03/11/%E9%A1%B9%E7%9B%AE/lottery/image-20230423164122783.png" alt="image-20230423164122783"></p>
<p>在应用层-抽奖流程中将“抽奖”和“发奖”进行解耦，以提高响应速度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DrawProcessResult <span class="title function_">doDrawProcess</span><span class="params">(DrawProcessReq req)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 领取活动</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 执行抽奖</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 结果落库</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 发送MQ，触发发奖流程</span></span><br><span class="line">    <span class="type">InvoiceVO</span> <span class="variable">invoiceVO</span> <span class="operator">=</span> buildInvoiceVO(drawOrderVO);</span><br><span class="line">    ListenableFuture&lt;SendResult&lt;String, Object&gt;&gt; future = kafkaProducer.sendLotteryInvoice(invoiceVO);</span><br><span class="line">    future.addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;SendResult&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult&lt;String, Object&gt; stringObjectSendResult)</span> &#123;</span><br><span class="line">            <span class="comment">// 4.1 MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span></span><br><span class="line">            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            <span class="comment">// 4.2 MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span></span><br><span class="line">            activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DrawProcessResult</span>(Constants.ResponseCode.SUCCESS.getCode(), Constants.ResponseCode.SUCCESS.getInfo(), drawAwardVO);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, Object&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MQ 主题： 中奖发货单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOPIC_INVOICE</span> <span class="operator">=</span> <span class="string">&quot;lottery_invoice&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送中奖货物发货单消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ListenableFuture&lt;SendResult&lt;String, Object&gt;&gt; <span class="title function_">sendLotteryInvoice</span><span class="params">(InvoiceVO invoice)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">objJson</span> <span class="operator">=</span> JSON.toJSONString(invoice);</span><br><span class="line">        log.info(<span class="string">&quot;发送MQ消息 topic：&#123;&#125; bizId：&#123;&#125; message：&#123;&#125;&quot;</span>, TOPIC_INVOICE, invoice.getuId(), objJson);</span><br><span class="line">        <span class="keyword">return</span> kafkaTemplate.send(TOPIC_INVOICE, objJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LotteryInvoiceListener</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DistributionGoodsFactory distributionGoodsFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;lottery_invoice&quot;, groupId = &quot;lottery&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(ConsumerRecord&lt;?, ?&gt; record, Acknowledgment ack, <span class="meta">@Header(KafkaHeaders.RECEIVED_TOPIC)</span> String topic)</span>&#123;</span><br><span class="line">        Optional&lt;?&gt; message = Optional.ofNullable(record.value());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 判断消息是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(!message.isPresent())&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 处理 MQ 消息</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 转化对象</span></span><br><span class="line">            <span class="type">InvoiceVO</span> <span class="variable">invoiceVO</span> <span class="operator">=</span> JSON.parseObject((String) message.get(), InvoiceVO.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 获取发送奖品工厂，执行发奖</span></span><br><span class="line">            <span class="type">IDistributionGoods</span> <span class="variable">distributionGoodsService</span> <span class="operator">=</span>  distributionGoodsFactory.getDistributionGoodsService(invoiceVO.getAwardType());</span><br><span class="line">            <span class="type">DistributionRes</span> <span class="variable">distributionRes</span> <span class="operator">=</span> distributionGoodsService.doDistribution(<span class="keyword">new</span> <span class="title class_">GoodsReq</span>(invoiceVO.getuId(), invoiceVO.getOrderId(),</span><br><span class="line">                    invoiceVO.getAwardId(), invoiceVO.getAwardName(), invoiceVO.getAwardContent()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 打印日志</span></span><br><span class="line">            log.info(<span class="string">&quot;消费MQ消息，完成 topic：&#123;&#125; bizId：&#123;&#125; 发奖结果：&#123;&#125;&quot;</span>, topic, invoiceVO.getuId(), JSON.toJSONString(distributionRes));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 消息消费完成</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">// 发奖环节失败，消息重试。所有到环节，发货、更新库，都需要保证幂等。</span></span><br><span class="line">            log.error(<span class="string">&quot;消费MQ消息，失败 topic：&#123;&#125; message：&#123;&#125;&quot;</span>, topic, message.get());</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="xxl-job使用"><a href="#xxl-job使用" class="headerlink" title="xxl-job使用"></a>xxl-job使用</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LotteryXxlJob</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *当ActivityState为PASS更新为DOING</span></span><br><span class="line"><span class="comment">    *当ActivityState为DOING且已经到了结束时间，更新为CLOSED</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;lotteryActivityStateJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lotteryActivityStateJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;扫描活动状态 Begin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取前十个活动状态为PASS或DOING的活动</span></span><br><span class="line">        List&lt;ActivityVO&gt; activityVOList = activityDeploy.scanToDoActivityList(<span class="number">0L</span>);</span><br><span class="line">        <span class="keyword">if</span> (activityVOList.isEmpty())&#123;</span><br><span class="line">            log.info(<span class="string">&quot;扫描活动状态 End 暂无符合需要扫描的活动列表&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!activityVOList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ActivityVO activityVO : activityVOList) &#123;</span><br><span class="line">                <span class="type">Integer</span> <span class="variable">state</span> <span class="operator">=</span> activityVO.getState();</span><br><span class="line">                <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">                    <span class="comment">// 活动状态为审核通过，在临近活动开启时间前，审核活动为活动中。在使用活动的时候，需要依照活动状态核时间两个字段进行判断和使用。</span></span><br><span class="line">                    <span class="keyword">case</span> ActivityState.PASS:</span><br><span class="line">                        <span class="type">Result</span> <span class="variable">state4Result</span> <span class="operator">=</span> stateHandler.doing(activityVO.getActivityId(), Constants.ActivityState.PASS);</span><br><span class="line">                        log.info(<span class="string">&quot;扫描活动状态为活动中 结果：&#123;&#125; activityId：&#123;&#125; activityName：&#123;&#125; creator：&#123;&#125;&quot;</span>, JSON.toJSONString(state4Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">// 扫描时间已过期的活动，从活动中状态变更为关闭状态【这里也可以细化为2个任务来处理，也可以把时间判断放到数据库中操作】</span></span><br><span class="line">                    <span class="keyword">case</span> ActivityState.DOING:</span><br><span class="line">                        <span class="keyword">if</span> (activityVO.getEndDateTime().before(<span class="keyword">new</span> <span class="title class_">Date</span>()))&#123;</span><br><span class="line">                            <span class="type">Result</span> <span class="variable">state5Result</span> <span class="operator">=</span> stateHandler.close(activityVO.getActivityId(), Constants.ActivityState.DOING);</span><br><span class="line">                            log.info(<span class="string">&quot;扫描活动状态为关闭 结果：&#123;&#125; activityId：&#123;&#125; activityName：&#123;&#125; creator：&#123;&#125;&quot;</span>, JSON.toJSONString(state5Result), activityVO.getActivityId(), activityVO.getActivityName(), activityVO.getCreator());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//继续扫描接下来符合PASS和DOING的activity的10条记录</span></span><br><span class="line">            <span class="type">ActivityVO</span> <span class="variable">activityVO</span> <span class="operator">=</span> activityVOList.get(activityVOList.size() - <span class="number">1</span>);</span><br><span class="line">            activityVOList = activityDeploy.scanToDoActivityList(activityVO.getId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;扫描活动状态 End&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;lotteryOrderMQStateJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lotteryOrderMQStateJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;     </span><br><span class="line">        <span class="comment">// 扫描库表数据,查询mq状态为失败的活动</span></span><br><span class="line">        List&lt;InvoiceVO&gt; invoiceVOList = activityPartake.scanInvoiceMqState(dbCount, i);</span><br><span class="line">        log.info(<span class="string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 扫描库：&#123;&#125; 扫描表：&#123;&#125; 扫描数：&#123;&#125;&quot;</span>, dbCount, i, invoiceVOList.size());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 补偿 MQ 消息</span></span><br><span class="line">        <span class="keyword">for</span> (InvoiceVO invoiceVO : invoiceVOList) &#123;</span><br><span class="line"></span><br><span class="line">            ListenableFuture&lt;SendResult&lt;String, Object&gt;&gt; future = kafkaProducer.sendLotteryInvoice(invoiceVO);</span><br><span class="line">            future.addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;SendResult&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult&lt;String, Object&gt; stringObjectSendResult)</span> &#123;</span><br><span class="line">                    <span class="comment">// MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span></span><br><span class="line">                    activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.COMPLETE.getCode());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                    <span class="comment">// MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span></span><br><span class="line">                    activityPartake.updateInvoiceMqState(invoiceVO.getuId(), invoiceVO.getOrderId(), Constants.MQState.FAIL.getCode());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
			<br>
			
		</article>
	</div>
	<div class="other">
		<div class="container">
			<nav class="post-nav">

    
         <!-- 先找到与当前文字相同的目录 -->
            
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                
            
                 
                 <!-- 在找到当前文章所在的 index -->
                    
                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                         

                        

                         <!-- 下一篇文章 --> 
                            <div class="new">
                                <span>下一章</span>
                                <a href="/2024/03/11/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"> 计算机网络.md</a>
                            </div>
                        

                    
                         

                        

                        

                    
                         

                          <!-- 上一篇文章 --> 
                            <div class="old">
                                <span>上一章</span>
                                <a href="/2024/03/11/%E9%A1%B9%E7%9B%AE/mit824/"> mit6.824.md</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
        
    
        
    

    
        
    
        
    

    
        
    
        
    

    
        
    
        
    

    
        
    
        
    

    
        
    
        
    

    
        
    
         <!-- 先找到与当前文字相同的目录 -->
            
            
                 
                 <!-- 在找到当前文章所在的 index -->
                    
                    
                         

                        

                        

                    
                         

                          <!-- 上一篇文章 --> 
                            <div class="old">
                                <span>上一章</span>
                                <a href="/2024/03/11/%E9%A1%B9%E7%9B%AE/mit824/"> mit6.824.md</a>
                            </div>
                        

                        

                    
                         

                        

                        

                    
                         

                        

                        

                    
                
            
                 
                
            
                 
                
            
                 
                
            
        
    

</nav> 
		</div>
	</div>
	<div class="container comment">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
	</div>
</div>
		<div class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-left">1Stack1</div>
            <div class="footer-right"> 
                <div class="footer-links">
                    
                        <a target="_blank" rel="noopener" href="https://nexmoe.com/">折影轻梦</a>
                    
                        <a target="_blank" rel="noopener" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books">还有书籍</a>
                    
                </div>
                <div calss="footer-copyright">&copy; 2024 1Stack1
                    Using <a rel="noreferrer" href="http://hexo.io/" target="_blank">Hexo</a> 
                    &amp; <a rel="noreferrer" href="https://github.com/Yet-The-Books/hexo-theme-yet-the-books" target="_blank">Yet The Books</a>
                </div>
            </div>  
        </div>
    </div>
</div>
	</body>
</html>
