<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Executor.md | 1Stack1</title>
  <meta name="keywords" content="">
  <meta name="description" content="Executor.md | 1Stack1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="ä»‹ç»AQS å°±æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦ç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨ï¼Œä¸ºä»–ä»¬çš„å®ç°æä¾›äº†é€šç”¨åŠŸèƒ½çš„å®ç° æ ¸å¿ƒæ€æƒ³AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯åŸºäº CLH é” ï¼ˆCraig, Landin, and Hagersten lock">
<meta property="og:type" content="article">
<meta property="og:title" content="AQS.md">
<meta property="og:url" content="https://1stack1.github.io/2024/03/11/note/juc/AQS/index.html">
<meta property="og:site_name" content="1Stack1">
<meta property="og:description" content="ä»‹ç»AQS å°±æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦ç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨ï¼Œä¸ºä»–ä»¬çš„å®ç°æä¾›äº†é€šç”¨åŠŸèƒ½çš„å®ç° æ ¸å¿ƒæ€æƒ³AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯åŸºäº CLH é” ï¼ˆCraig, Landin, and Hagersten lock">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190041184.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419185922426-1710173058095.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419185941383.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190244474.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190325126.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190337744-1710173000935.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190358666.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190428798.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190444473.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190501636.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190537899.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190549899.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190603894.png">
<meta property="og:image" content="https://1stack1.github.io/.io//image-20230419190617127.png">
<meta property="article:published_time" content="2024-03-11T15:50:50.000Z">
<meta property="article:modified_time" content="2024-03-11T16:11:01.998Z">
<meta property="article:author" content="1Stack1">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://1stack1.github.io/.io//image-20230419190041184.png">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.1.1"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>1Stack1</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="facebook"
               href="https://www.facebook.com/faker.tops"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-facebook"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
            <a title="instagram"
               href="https://www.facebook.com/faker.tops"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-instagram"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="reddit"
               href="https://www.reddit.com/user/yelog/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-reddit"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="http://weibo.com/u/2307534817"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="jianshu"
               href="https://www.jianshu.com/u/ff56736de7cf"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-jianshu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/people/jaytp/activities"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="oschina"
               href="https://my.oschina.net/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-oschina"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="email"
               href="mailto:jaytp@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=872336115&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="kugou"
               href="https://www.kugou.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-kugou"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="neteasemusic"
               href="https://music.163.com/#/user/home?id=88151013"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-neteasemusic"></use>
                    </svg>
                
            </a>
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(8)</small>
            
        </div>
    </li>
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="8">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">å¶è½é˜</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="æœç´¢ å¿«æ·é”® i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="åˆ‡æ¢åˆ°å¤§çº²è§†å›¾ å¿«æ·é”® w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="è¿”å›"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="å¤§å°å†™æ•æ„Ÿ"></i>
            <i class="iconfont icon-tag" data-title="æ ‡ç­¾"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">å¤§çº²</div>
            <i class="iconfont icon-list" data-title="åˆ‡æ¢åˆ°æ–‡ç« åˆ—è¡¨"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/AQS/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="AQS.md">AQS.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/ConcurrentHashMap/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="ConcurrentHashMap.md">ConcurrentHashMap.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/cas/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="cas.md">cas.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/Executor/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Executor.md">Executor.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/Future/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Future.md">Future.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/volitile/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="volitile.md">volitile.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/ThreadLocal/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="ThreadLocal.md">ThreadLocal.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        
        <a  class="All "
           href="/2024/03/11/note/juc/synchronized/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="synchronized.md">synchronized.md</span>
            <span class="post-date" title="2024-03-11 23:50:50">2024/03/11</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="åˆ‡æ¢å…¨å± å¿«æ·é”® s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-note/juc/Executor" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Executor.md</h1>
    
    <div class="article-meta">
        
        
        
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2024-03-12 00:11:46'>2024-03-11 23:50</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views ğŸ‘€ :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-text">ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="toc-text">ç»§æ‰¿å…³ç³»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="toc-text">è¿è¡Œæœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86"><span class="toc-text">ç”Ÿå‘½å‘¨æœŸç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-text">ä»»åŠ¡ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-text">ä»»åŠ¡è°ƒåº¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E7%BC%93%E5%86%B2"><span class="toc-text">ä»»åŠ¡ç¼“å†²</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E7%94%B3%E8%AF%B7"><span class="toc-text">ä»»åŠ¡ç”³è¯·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8B%92%E7%BB%9D"><span class="toc-text">ä»»åŠ¡æ‹’ç»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-text">åˆ›å»ºçº¿ç¨‹æ± çš„ä¸¤ç§æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="toc-text">çº¿ç¨‹ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Worker%E7%BA%BF%E7%A8%8B"><span class="toc-text">Workerçº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0Worker%E7%BA%BF%E7%A8%8B"><span class="toc-text">å¢åŠ Workerçº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Worker%E7%BA%BF%E7%A8%8B%E5%9B%9E%E6%94%B6"><span class="toc-text">Workerçº¿ç¨‹å›æ”¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Worker%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-text">Workerçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C"><span class="toc-text">å¼‚æ­¥è®¡ç®—ç»“æœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-text">åº”ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#execute%E6%96%B9%E6%B3%95"><span class="toc-text">executeæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-text">ä¼ªä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-text">æºç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submit%E6%96%B9%E6%B3%95"><span class="toc-text">submitæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="toc-text">ä¼ªä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-1"><span class="toc-text">æºç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#execute-vssubmit"><span class="toc-text">execute()vssubmit()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addWorker%E6%96%B9%E6%B3%95"><span class="toc-text">addWorkeræ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-2"><span class="toc-text">ä¼ªä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-2"><span class="toc-text">æºç </span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h1><p>çº¿ç¨‹æ± æ ¸å¿ƒå®ç°ç±»æ˜¯ThreadPoolExecutor</p>
<h2 id="ç»§æ‰¿å…³ç³»"><a href="#ç»§æ‰¿å…³ç³»" class="headerlink" title="ç»§æ‰¿å…³ç³»"></a>ç»§æ‰¿å…³ç³»</h2><p><img src="/.io//image-20230811143847577.png" alt="image-20230811143847577"></p>
<p>é¡¶å±‚æ¥å£<strong>Executor</strong>æä¾›äº†ä¸€ç§æ€æƒ³ï¼šå°†<strong>ä»»åŠ¡æäº¤</strong>å’Œ<strong>ä»»åŠ¡æ‰§è¡Œ</strong>è¿›è¡Œè§£è€¦ã€‚</p>
<p><strong>ThreadPoolExecutor</strong>å°†ä¼šä¸€æ–¹é¢<strong>ç»´æŠ¤è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œå¦ä¸€æ–¹é¢<strong>åŒæ—¶ç®¡ç†çº¿ç¨‹å’Œä»»åŠ¡</strong></p>
<h2 id="è¿è¡Œæœºåˆ¶"><a href="#è¿è¡Œæœºåˆ¶" class="headerlink" title="è¿è¡Œæœºåˆ¶"></a>è¿è¡Œæœºåˆ¶</h2><p><img src="/.io//77441586f6b312a54264e3fcf5eebe2663494.png" alt="å›¾2 ThreadPoolExecutorè¿è¡Œæµç¨‹"></p>
<p>çº¿ç¨‹æ± åœ¨å†…éƒ¨å®é™…ä¸Šæ„å»ºäº†ä¸€ä¸ª<strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</strong>ï¼Œå°†çº¿ç¨‹å’Œä»»åŠ¡ä¸¤è€…è§£è€¦ï¼Œå¹¶ä¸ç›´æ¥å…³è”ï¼Œä»è€Œè‰¯å¥½çš„ç¼“å†²ä»»åŠ¡ï¼Œå¤ç”¨çº¿ç¨‹ã€‚</p>
<p>çº¿ç¨‹æ± çš„è¿è¡Œä¸»è¦åˆ†æˆä¸¤éƒ¨åˆ†ï¼šä»»åŠ¡ç®¡ç†ã€çº¿ç¨‹ç®¡ç†ã€‚</p>
<p><strong>ä»»åŠ¡ç®¡ç†</strong>éƒ¨åˆ†å……å½“<strong>ç”Ÿäº§è€…</strong>çš„è§’è‰²ï¼Œå½“ä»»åŠ¡æäº¤åï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­è¯¥ä»»åŠ¡åç»­çš„æµè½¬</p>
<ul>
<li><p>ç›´æ¥ç”³è¯·çº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ï¼›</p>
</li>
<li><p>ç¼“å†²åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…çº¿ç¨‹æ‰§è¡Œï¼›</p>
</li>
<li><p>æ‹’ç»è¯¥ä»»åŠ¡ã€‚</p>
</li>
</ul>
<p><strong>çº¿ç¨‹ç®¡ç†</strong>éƒ¨åˆ†æ˜¯<strong>æ¶ˆè´¹è€…</strong>ï¼Œå®ƒä»¬è¢«ç»Ÿä¸€ç»´æŠ¤åœ¨çº¿ç¨‹æ± å†…ï¼Œæ ¹æ®ä»»åŠ¡è¯·æ±‚è¿›è¡Œçº¿ç¨‹çš„åˆ†é…ï¼Œå½“çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ååˆ™ä¼šç»§ç»­è·å–æ–°çš„ä»»åŠ¡å»æ‰§è¡Œï¼Œæœ€ç»ˆå½“çº¿ç¨‹è·å–ä¸åˆ°ä»»åŠ¡çš„æ—¶å€™ï¼Œçº¿ç¨‹å°±ä¼šè¢«å›æ”¶ã€‚</p>
<h2 id="ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>ç”Ÿå‘½å‘¨æœŸç®¡ç†</h2><p>çº¿ç¨‹æ± è¿è¡Œçš„<strong>çŠ¶æ€</strong>ï¼Œå¹¶ä¸æ˜¯ç”¨æˆ·æ˜¾å¼è®¾ç½®çš„ï¼Œè€Œæ˜¯ä¼´éšç€çº¿ç¨‹æ± çš„è¿è¡Œï¼Œ<strong>ç”±å†…éƒ¨æ¥ç»´æŠ¤</strong>ã€‚</p>
<p>çº¿ç¨‹æ± å†…éƒ¨ä½¿ç”¨<strong>ä¸€ä¸ªAtomicIntegerå˜é‡ç»´æŠ¤ä¸¤ä¸ªå€¼</strong>ï¼š**è¿è¡ŒçŠ¶æ€(runState)å’Œçº¿ç¨‹æ•°é‡ (workerCount)**ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p><strong>é«˜3ä½ä¿å­˜runStateï¼Œä½29ä½ä¿å­˜workerCount</strong>ï¼Œä¸¤ä¸ªå˜é‡ä¹‹é—´<strong>äº’ä¸å¹²æ‰°</strong>ã€‚</p>
<p>ç”¨ä¸€ä¸ªå˜é‡å»å­˜å‚¨ä¸¤ä¸ªå€¼ï¼Œ<strong>å¯é¿å…åœ¨åšç›¸å…³å†³ç­–æ—¶ï¼Œå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¸å¿…ä¸ºäº†ç»´æŠ¤ä¸¤è€…çš„ä¸€è‡´ï¼Œè€Œå ç”¨é”èµ„æº</strong>ã€‚</p>
<p>çº¿ç¨‹æ± ä¸­ç»å¸¸å‡ºç°è¦åŒæ—¶åˆ¤æ–­çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€å’Œçº¿ç¨‹æ•°é‡çš„æƒ…å†µã€‚çº¿ç¨‹æ± ä¹Ÿæä¾›äº†è‹¥å¹²æ–¹æ³•å»ä¾›ç”¨æˆ·è·å¾—çº¿ç¨‹æ± å½“å‰çš„è¿è¡ŒçŠ¶æ€ã€çº¿ç¨‹ä¸ªæ•°ã€‚è¿™é‡Œéƒ½ä½¿ç”¨çš„æ˜¯ä½è¿ç®—çš„æ–¹å¼ï¼Œç›¸æ¯”äºåŸºæœ¬è¿ç®—ï¼Œé€Ÿåº¦ä¹Ÿä¼šå¿«å¾ˆå¤šã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;<span class="comment">//29</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span> Â  <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 3ä¸ªé«˜ä½çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºçº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span> Â  Â <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;<span class="comment">// é«˜3ä½ï¼š111</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span> Â  <span class="operator">=</span> Â <span class="number">0</span> &lt;&lt; COUNT_BITS;<span class="comment">// é«˜3ä½ï¼š000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span> Â  Â  Â  <span class="operator">=</span> Â <span class="number">1</span> &lt;&lt; COUNT_BITS;<span class="comment">// é«˜3ä½ï¼š001</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span> Â  Â <span class="operator">=</span> Â <span class="number">2</span> &lt;&lt; COUNT_BITS;<span class="comment">// é«˜3ä½ï¼š010</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span> Â <span class="number">3</span> &lt;&lt; COUNT_BITS;<span class="comment">// é«˜3ä½ï¼š011</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ctlæ‹†åŒ…æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span> Â  Â  &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>

<p>ThreadPoolExecutorçš„è¿è¡ŒçŠ¶æ€æœ‰5ç§ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<p><img src="/.io//62853fa44bfa47d63143babe3b5a4c6e82532.png" alt="img"></p>
<p>å…¶ç”Ÿå‘½å‘¨æœŸè½¬æ¢å¦‚ä¸‹å…¥æ‰€ç¤ºï¼š</p>
<p><img src="/.io//582d1606d57ff99aa0e5f8fc59c7819329028.png" alt="å›¾3 çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ"></p>
<h2 id="ä»»åŠ¡ç®¡ç†"><a href="#ä»»åŠ¡ç®¡ç†" class="headerlink" title="ä»»åŠ¡ç®¡ç†"></a>ä»»åŠ¡ç®¡ç†</h2><h3 id="ä»»åŠ¡è°ƒåº¦"><a href="#ä»»åŠ¡è°ƒåº¦" class="headerlink" title="ä»»åŠ¡è°ƒåº¦"></a>ä»»åŠ¡è°ƒåº¦</h3><p><strong>ä»»åŠ¡è°ƒåº¦</strong>æ˜¯çº¿ç¨‹æ± çš„ä¸»è¦å…¥å£ï¼Œå½“ç”¨æˆ·æäº¤äº†ä¸€ä¸ªä»»åŠ¡ï¼Œ<strong>æ¥ä¸‹æ¥è¿™ä¸ªä»»åŠ¡å°†å¦‚ä½•æ‰§è¡Œ</strong>éƒ½æ˜¯ç”±è¿™ä¸ªé˜¶æ®µå†³å®šçš„ã€‚</p>
<p>æ‰€æœ‰ä»»åŠ¡çš„è°ƒåº¦éƒ½æ˜¯ç”±<strong>executeæ–¹æ³•</strong>å®Œæˆçš„ï¼Œè¿™éƒ¨åˆ†å®Œæˆçš„å·¥ä½œæ˜¯ï¼š</p>
<ul>
<li>æ£€æŸ¥ç°åœ¨çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ã€è¿è¡Œçº¿ç¨‹æ•°ã€è¿è¡Œç­–ç•¥ï¼Œ</li>
<li>å†³å®šæ¥ä¸‹æ¥æ‰§è¡Œçš„æµç¨‹ï¼Œæ˜¯ç›´æ¥ç”³è¯·çº¿ç¨‹æ‰§è¡Œï¼Œæˆ–æ˜¯ç¼“å†²åˆ°é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œäº¦æˆ–æ˜¯ç›´æ¥æ‹’ç»è¯¥ä»»åŠ¡ã€‚</li>
</ul>
<p>å…¶æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆæ£€æµ‹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯RUNNINGï¼Œåˆ™ç›´æ¥æ‹’ç»ï¼Œçº¿ç¨‹æ± è¦ä¿è¯åœ¨RUNNINGçš„çŠ¶æ€ä¸‹æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>å¦‚æœworkerCount &lt; corePoolSizeï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚</li>
<li>å¦‚æœworkerCount &gt;&#x3D; corePoolSizeï¼Œä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ·»åŠ åˆ°è¯¥é˜»å¡é˜Ÿåˆ—ä¸­ã€‚</li>
<li>å¦‚æœworkerCount &gt;&#x3D; corePoolSize &amp;&amp; workerCount &lt; maximumPoolSizeï¼Œä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚</li>
<li>å¦‚æœworkerCount &gt;&#x3D; maximumPoolSizeï¼Œå¹¶ä¸”çº¿ç¨‹æ± å†…çš„é˜»å¡é˜Ÿåˆ—å·²æ»¡, åˆ™æ ¹æ®æ‹’ç»ç­–ç•¥æ¥å¤„ç†è¯¥ä»»åŠ¡, é»˜è®¤çš„å¤„ç†æ–¹å¼æ˜¯ç›´æ¥æŠ›å¼‚å¸¸ã€‚</li>
</ol>
<p>å…¶æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/.io//31bad766983e212431077ca8da92762050214.png" alt="å›¾4 ä»»åŠ¡è°ƒåº¦æµç¨‹"></p>
<h3 id="ä»»åŠ¡ç¼“å†²"><a href="#ä»»åŠ¡ç¼“å†²" class="headerlink" title="ä»»åŠ¡ç¼“å†²"></a>ä»»åŠ¡ç¼“å†²</h3><p>çº¿ç¨‹æ± çš„æ€æƒ³å°±æ˜¯å°†<strong>ä»»åŠ¡å’Œçº¿ç¨‹ä¸¤è€…è§£è€¦</strong>ï¼Œä¸è®©ä¸¤è€…ç›´æ¥å…³è”ï¼Œæ¥å¯¹ä»»åŠ¡å’Œçº¿ç¨‹çš„ç®¡ç†ã€‚</p>
<p>çº¿ç¨‹æ± ä¸­æ˜¯ä»¥<strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</strong>ï¼Œé€šè¿‡ä¸€ä¸ª<strong>é˜»å¡é˜Ÿåˆ—</strong>æ¥å®ç°çš„ã€‚</p>
<p>é˜»å¡é˜Ÿåˆ—ç¼“å­˜ä»»åŠ¡ï¼Œå·¥ä½œçº¿ç¨‹ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚</p>
<p>é˜»å¡é˜Ÿåˆ—(BlockingQueue)æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ çš„æ“ä½œæ˜¯ï¼š</p>
<ul>
<li><p>åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚</p>
</li>
<li><p>å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå­˜å‚¨å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å¯ç”¨ã€‚</p>
</li>
</ul>
<p><img src="/.io//f4d89c87acf102b45be8ccf3ed83352a9497.png" alt="å›¾5 é˜»å¡é˜Ÿåˆ—"></p>
<p><img src="/.io//725a3db5114d95675f2098c12dc331c3316963.png" alt="img"></p>
<h3 id="ä»»åŠ¡ç”³è¯·"><a href="#ä»»åŠ¡ç”³è¯·" class="headerlink" title="ä»»åŠ¡ç”³è¯·"></a>ä»»åŠ¡ç”³è¯·</h3><p>ä»»åŠ¡çš„æ‰§è¡Œæœ‰ä¸¤ç§å¯èƒ½ï¼š</p>
<ul>
<li><p>ä»»åŠ¡ç›´æ¥ç”±æ–°åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œã€‚</p>
</li>
<li><p>çº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ç„¶åæ‰§è¡Œï¼Œæ‰§è¡Œå®Œä»»åŠ¡çš„ç©ºé—²çº¿ç¨‹ä¼šå†æ¬¡å»ä»é˜Ÿåˆ—ä¸­ç”³è¯·ä»»åŠ¡å†å»æ‰§è¡Œã€‚</p>
</li>
</ul>
<p>ç¬¬ä¸€ç§æƒ…å†µä»…å‡ºç°åœ¨<strong>çº¿ç¨‹åˆå§‹åˆ›å»º</strong>çš„æ—¶å€™ï¼Œç¬¬äºŒç§æ˜¯çº¿ç¨‹è·å–ä»»åŠ¡ç»å¤§å¤šæ•°çš„æƒ…å†µã€‚</p>
<p>çº¿ç¨‹éœ€è¦ä»ä»»åŠ¡ç¼“å­˜æ¨¡å—ä¸­ä¸æ–­åœ°å–ä»»åŠ¡æ‰§è¡Œï¼Œå¸®åŠ©çº¿ç¨‹ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œå®ç°çº¿ç¨‹ç®¡ç†æ¨¡å—å’Œä»»åŠ¡ç®¡ç†æ¨¡å—ä¹‹é—´çš„é€šä¿¡ã€‚è¿™éƒ¨åˆ†ç­–ç•¥ç”±<strong>getTaskæ–¹æ³•</strong>å®ç°ï¼Œå…¶æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/.io//49d8041f8480aba5ef59079fcc7143b996706.png" alt="å›¾6 è·å–ä»»åŠ¡æµç¨‹å›¾"></p>
<p>getTaskè¿™éƒ¨åˆ†è¿›è¡Œäº†å¤šæ¬¡åˆ¤æ–­ï¼Œä¸ºçš„æ˜¯<strong>æ§åˆ¶çº¿ç¨‹çš„æ•°é‡</strong>ï¼Œä½¿å…¶ç¬¦åˆçº¿ç¨‹æ± çš„çŠ¶æ€ã€‚</p>
<p>å¦‚æœçº¿ç¨‹æ± ç°åœ¨ä¸åº”è¯¥æŒæœ‰é‚£ä¹ˆå¤šçº¿ç¨‹ï¼Œåˆ™ä¼šè¿”å›nullå€¼ã€‚</p>
<p>å·¥ä½œçº¿ç¨‹Workerä¼šä¸æ–­æ¥æ”¶æ–°ä»»åŠ¡å»æ‰§è¡Œï¼Œè€Œå½“å·¥ä½œçº¿ç¨‹Workeræ¥æ”¶ä¸åˆ°ä»»åŠ¡çš„æ—¶å€™ï¼Œå°±ä¼šå¼€å§‹è¢«å›æ”¶ã€‚</p>
<h3 id="ä»»åŠ¡æ‹’ç»"><a href="#ä»»åŠ¡æ‹’ç»" class="headerlink" title="ä»»åŠ¡æ‹’ç»"></a>ä»»åŠ¡æ‹’ç»</h3><p>ä»»åŠ¡æ‹’ç»æ¨¡å—æ˜¯çº¿ç¨‹æ± çš„ä¿æŠ¤éƒ¨åˆ†ï¼Œçº¿ç¨‹æ± æœ‰ä¸€ä¸ªæœ€å¤§çš„å®¹é‡ï¼Œå½“çº¿ç¨‹æ± çš„ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—å·²æ»¡ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°maximumPoolSizeæ—¶ï¼Œå°±éœ€è¦æ‹’ç»æ‰è¯¥ä»»åŠ¡ï¼Œé‡‡å–ä»»åŠ¡æ‹’ç»ç­–ç•¥ï¼Œä¿æŠ¤çº¿ç¨‹æ± ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	é¡¶çº§æ¥å£</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RejectedExecutionHandler</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	å®ç°ç±»</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"><span class="comment">//è°ƒç”¨çº¿ç¨‹æ‰§è¡Œr</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CallerRunsPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CallerRunsPolicy</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">            r.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠ›å‡º RejectedExecutionExceptionæ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AbortPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbortPolicy</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Task &quot;</span> + r.toString() +</span><br><span class="line">                                             <span class="string">&quot; rejected from &quot;</span> +</span><br><span class="line">                                             e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DiscardPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DiscardPolicy</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DiscardOldestPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DiscardOldestPolicy</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">            e.getQueue().poll();</span><br><span class="line">            e.execute(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´</span></span><br><span class="line"><span class="params">                          TimeUnit unit,//æ—¶é—´å•ä½</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡</span></span><br><span class="line"><span class="params">                         )</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">        keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (workQueue == <span class="literal">null</span> || threadFactory == <span class="literal">null</span> || handler == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="built_in">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="built_in">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="built_in">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="built_in">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="built_in">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="åˆ›å»ºçº¿ç¨‹æ± çš„ä¸¤ç§æ–¹æ³•"><a href="#åˆ›å»ºçº¿ç¨‹æ± çš„ä¸¤ç§æ–¹æ³•" class="headerlink" title="åˆ›å»ºçº¿ç¨‹æ± çš„ä¸¤ç§æ–¹æ³•"></a>åˆ›å»ºçº¿ç¨‹æ± çš„ä¸¤ç§æ–¹æ³•</h2><ul>
<li><p>é€šè¿‡ä¸ƒä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•æ„é€ </p>
</li>
<li><p>é€šè¿‡Executorså·¥å…·ç±»å»åˆ›å»º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,<span class="number">0L</span>, TimeUnit.MILLISECONDS,<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span> (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,<span class="number">0L</span>, TimeUnit.MILLISECONDS,<span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒæ­¥é˜Ÿåˆ— SynchronousQueueï¼Œæ²¡æœ‰å®¹é‡ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUE`</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,<span class="number">60L</span>, TimeUnit.SECONDS,<span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DelayedWorkQueueï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ScheduledThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">DelayedWorkQueue</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="çº¿ç¨‹ç®¡ç†"><a href="#çº¿ç¨‹ç®¡ç†" class="headerlink" title="çº¿ç¨‹ç®¡ç†"></a>çº¿ç¨‹ç®¡ç†</h2><h3 id="Workerçº¿ç¨‹"><a href="#Workerçº¿ç¨‹" class="headerlink" title="Workerçº¿ç¨‹"></a>Workerçº¿ç¨‹</h3><p>çº¿ç¨‹æ± ä¸ºäº†<strong>æŒæ¡çº¿ç¨‹çš„çŠ¶æ€</strong>å¹¶<strong>ç»´æŠ¤çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œè®¾è®¡äº†çº¿ç¨‹æ± å†…çš„å·¥ä½œçº¿ç¨‹Workerã€‚</p>
<p>éƒ¨åˆ†ä»£ç ï¼š</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread thread;<span class="comment">//WorkeræŒæœ‰çš„çº¿ç¨‹</span></span><br><span class="line">    Runnable firstTask;<span class="comment">//åˆå§‹åŒ–çš„ä»»åŠ¡ï¼Œå¯ä»¥ä¸ºnull</span></span><br><span class="line">    </span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">          setState(-<span class="number">1</span>); <span class="comment">// ç¦æ­¢ä¸­æ–­ï¼Œç›´åˆ°runWorker</span></span><br><span class="line">          <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">          <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Workerè¿™ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œå¹¶æŒæœ‰ä¸€ä¸ªçº¿ç¨‹threadï¼Œä¸€ä¸ªåˆå§‹åŒ–çš„ä»»åŠ¡firstTaskã€‚</p>
<ul>
<li><p>threadæ˜¯åœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶é€šè¿‡ThreadFactoryæ¥åˆ›å»ºçš„çº¿ç¨‹ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œä»»åŠ¡ï¼›</p>
</li>
<li><p>firstTaskç”¨å®ƒæ¥ä¿å­˜ä¼ å…¥çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡å¯ä»¥æœ‰ä¹Ÿå¯ä»¥ä¸ºnullã€‚</p>
<ul>
<li>å¦‚æœè¿™ä¸ªå€¼æ˜¯<strong>éç©º</strong>çš„ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±ä¼šåœ¨å¯åŠ¨åˆæœŸç«‹å³æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œä¹Ÿå°±å¯¹åº”<strong>æ ¸å¿ƒçº¿ç¨‹åˆ›å»º</strong>æ—¶çš„æƒ…å†µï¼›</li>
<li>å¦‚æœè¿™ä¸ªå€¼æ˜¯<strong>null</strong>ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ï¼ˆworkQueueï¼‰ä¸­çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯<strong>éæ ¸å¿ƒçº¿ç¨‹çš„åˆ›å»º</strong>ã€‚</li>
</ul>
</li>
</ul>
<p>Workeræ‰§è¡Œä»»åŠ¡çš„æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>  <img src="/.io//03268b9dc49bd30bb63064421bb036bf90315.png" alt="å›¾7 Workeræ‰§è¡Œä»»åŠ¡"></p>
<p>çº¿ç¨‹æ± éœ€è¦ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œéœ€è¦åœ¨çº¿ç¨‹é•¿æ—¶é—´ä¸è¿è¡Œçš„æ—¶å€™è¿›è¡Œå›æ”¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##ThreadPoolExcutor</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br></pre></td></tr></table></figure>

<p>çº¿ç¨‹æ± ä½¿ç”¨ä¸€å¼ Hashè¡¨å»æŒæœ‰çº¿ç¨‹çš„å¼•ç”¨ï¼Œè¿™æ ·å¯ä»¥<strong>é€šè¿‡æ·»åŠ å¼•ç”¨ã€ç§»é™¤å¼•ç”¨</strong>è¿™æ ·çš„æ“ä½œæ¥<strong>æ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</strong>ã€‚è¿™ä¸ªæ—¶å€™é‡è¦çš„å°±æ˜¯å¦‚ä½•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œã€‚</p>
<p>Workeræ˜¯é€šè¿‡<strong>ç»§æ‰¿AQS</strong>ï¼Œä½¿ç”¨AQSæ¥<strong>å®ç°ç‹¬å é”</strong>è¿™ä¸ªåŠŸèƒ½ã€‚æ²¡æœ‰ä½¿ç”¨å¯é‡å…¥é”ReentrantLockï¼Œè€Œæ˜¯ä½¿ç”¨AQSï¼Œ<strong>ä¸ºçš„å°±æ˜¯å®ç°ä¸å¯é‡å…¥çš„ç‰¹æ€§</strong>(è·å–çº¿ç¨‹çŠ¶æ€çš„çº¿ç¨‹æ˜¯çº¿ç¨‹æ± å¤–éƒ¨çš„çº¿ç¨‹)å»<strong>ååº”çº¿ç¨‹ç°åœ¨çš„æ‰§è¡ŒçŠ¶æ€</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	1.lockæ–¹æ³•ä¸€æ—¦è·å–äº†ç‹¬å é”ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡ä¸­ã€‚</p>
<p>â€‹	2.å¦‚æœæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™ä¸åº”è¯¥ä¸­æ–­çº¿ç¨‹ã€‚ </p>
<p>â€‹	3.å¦‚æœè¯¥çº¿ç¨‹ç°åœ¨ä¸æ˜¯ç‹¬å é”çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç©ºé—²çš„çŠ¶æ€ï¼Œè¯´æ˜å®ƒæ²¡æœ‰åœ¨å¤„ç†ä»»åŠ¡ï¼Œè¿™æ—¶å¯ä»¥å¯¹è¯¥çº¿ç¨‹è¿›è¡Œä¸­æ–­ã€‚</p>
<p>â€‹	4.çº¿ç¨‹æ± åœ¨æ‰§è¡Œshutdownæ–¹æ³•æˆ–tryTerminateæ–¹æ³•æ—¶ä¼šè°ƒç”¨interruptIdleWorkersæ–¹æ³•æ¥ä¸­æ–­ç©ºé—²çš„çº¿ç¨‹ï¼ŒinterruptIdleWorkers		æ–¹æ³•ä¼šä½¿ç”¨tryLockæ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç©ºé—²çŠ¶æ€ï¼›</p>
<p>â€‹	5.å¦‚æœçº¿ç¨‹æ˜¯ç©ºé—²çŠ¶æ€åˆ™å¯ä»¥å®‰å…¨å›æ”¶ã€‚</p>
<p>  åœ¨çº¿ç¨‹å›æ”¶è¿‡ç¨‹ä¸­å°±ä½¿ç”¨åˆ°äº†è¿™ç§ç‰¹æ€§ï¼Œå›æ”¶è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>  <img src="/.io//9d8dc9cebe59122127460f81a98894bb34085.png" alt="å›¾8 çº¿ç¨‹æ± å›æ”¶è¿‡ç¨‹"></p>
<h3 id="å¢åŠ Workerçº¿ç¨‹"><a href="#å¢åŠ Workerçº¿ç¨‹" class="headerlink" title="å¢åŠ Workerçº¿ç¨‹"></a>å¢åŠ Workerçº¿ç¨‹</h3><p> å¢åŠ çº¿ç¨‹æ˜¯é€šè¿‡<strong>çº¿ç¨‹æ± ä¸­çš„addWorkeræ–¹æ³•</strong>ï¼Œè¯¥æ–¹æ³•çš„åŠŸèƒ½å°±æ˜¯å¢åŠ ä¸€ä¸ªçº¿ç¨‹ï¼Œè¯¥æ–¹æ³•ä¸è€ƒè™‘çº¿ç¨‹æ± æ˜¯åœ¨å“ªä¸ªé˜¶æ®µå¢åŠ çš„è¯¥çº¿ç¨‹ï¼Œè¿™ä¸ªåˆ†é…çº¿ç¨‹çš„ç­–ç•¥æ˜¯åœ¨ä¸Šä¸ªæ­¥éª¤å®Œæˆçš„ï¼Œè¯¥æ­¥éª¤<strong>ä»…ä»…å®Œæˆå¢åŠ çº¿ç¨‹ï¼Œå¹¶ä½¿å®ƒè¿è¡Œï¼Œæœ€åè¿”å›æ˜¯å¦æˆåŠŸè¿™ä¸ªç»“æœã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>firstTaskå‚æ•°ç”¨äºæŒ‡å®šæ–°å¢çš„çº¿ç¨‹æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥å‚æ•°å¯ä»¥ä¸ºç©ºï¼›</p>
</li>
<li><p>coreå‚æ•°ä¸ºtrueè¡¨ç¤ºåœ¨æ–°å¢çº¿ç¨‹æ—¶ä¼šåˆ¤æ–­å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°æ˜¯å¦å°‘äºcorePoolSizeï¼Œfalseè¡¨ç¤ºæ–°å¢çº¿ç¨‹å‰éœ€è¦åˆ¤æ–­å½“å‰æ´»åŠ¨çº¿ç¨‹æ•°æ˜¯å¦å°‘äºmaximumPoolSize</p>
<p><img src="/.io//49527b1bb385f0f43529e57b614f59ae145454.png" alt="å›¾9 ç”³è¯·çº¿ç¨‹æ‰§è¡Œæµç¨‹å›¾"></p>
</li>
</ul>
<h3 id="Workerçº¿ç¨‹å›æ”¶"><a href="#Workerçº¿ç¨‹å›æ”¶" class="headerlink" title="Workerçº¿ç¨‹å›æ”¶"></a>Workerçº¿ç¨‹å›æ”¶</h3><p> çº¿ç¨‹æ± ä¸­<strong>çº¿ç¨‹çš„é”€æ¯</strong>ä¾èµ–<strong>JVMè‡ªåŠ¨çš„å›æ”¶</strong>ï¼Œçº¿ç¨‹æ± åšçš„å·¥ä½œæ˜¯<strong>æ ¹æ®å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€ç»´æŠ¤ä¸€å®šæ•°é‡çš„çº¿ç¨‹å¼•ç”¨ï¼Œé˜²æ­¢è¿™éƒ¨åˆ†çº¿ç¨‹è¢«JVMå›æ”¶ï¼Œå½“çº¿ç¨‹æ± å†³å®šå“ªäº›çº¿ç¨‹éœ€è¦å›æ”¶æ—¶ï¼Œåªéœ€è¦å°†å…¶å¼•ç”¨æ¶ˆé™¤å³å¯</strong>ã€‚</p>
<p>Workerè¢«åˆ›å»ºå‡ºæ¥åï¼Œå°±ä¼šä¸æ–­åœ°è¿›è¡Œè½®è¯¢ï¼Œç„¶åè·å–ä»»åŠ¡å»æ‰§è¡Œï¼Œæ ¸å¿ƒçº¿ç¨‹å¯ä»¥æ— é™ç­‰å¾…è·å–ä»»åŠ¡ï¼Œéæ ¸å¿ƒçº¿ç¨‹è¦é™æ—¶è·å–ä»»åŠ¡ã€‚å½“Workeræ— æ³•è·å–åˆ°ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è·å–çš„ä»»åŠ¡ä¸ºç©ºæ—¶ï¼Œå¾ªç¯ä¼šç»“æŸï¼ŒWorkerä¼šä¸»åŠ¨æ¶ˆé™¤è‡ªèº«åœ¨çº¿ç¨‹æ± å†…çš„å¼•ç”¨ã€‚</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">##ThreadPoolExcutorå®ç°Runableçš„runæ¥å£</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    runWorker(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line">##ThreadPoolExcutor.runWorker()  </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    processWorkerExit(w, completedAbruptly);<span class="comment">//è·å–ä¸åˆ°ä»»åŠ¡æ—¶ï¼Œä¸»åŠ¨å›æ”¶è‡ªå·±</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>  çº¿ç¨‹å›æ”¶çš„å·¥ä½œæ˜¯åœ¨<strong>processWorkerExitæ–¹æ³•</strong>å®Œæˆçš„ã€‚</p>
<p>  <img src="/.io//90ea093549782945f2c968403fdc39d415386.png" alt="å›¾10 çº¿ç¨‹é”€æ¯æµç¨‹">  </p>
<p> äº‹å®ä¸Šï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå°†çº¿ç¨‹å¼•ç”¨ç§»å‡ºçº¿ç¨‹æ± å°±å·²ç»ç»“æŸäº†çº¿ç¨‹é”€æ¯çš„éƒ¨åˆ†ã€‚</p>
<p>ä½†ç”±äºå¼•èµ·çº¿ç¨‹é”€æ¯çš„å¯èƒ½æ€§æœ‰å¾ˆå¤šï¼Œçº¿ç¨‹æ± è¿˜è¦åˆ¤æ–­æ˜¯ä»€ä¹ˆå¼•å‘äº†è¿™æ¬¡é”€æ¯ï¼Œæ˜¯å¦è¦æ”¹å˜çº¿ç¨‹æ± çš„ç°é˜¶æ®µçŠ¶æ€ï¼Œæ˜¯å¦è¦æ ¹æ®æ–°çŠ¶æ€ï¼Œé‡æ–°åˆ†é…çº¿ç¨‹ã€‚</p>
<h3 id="Workerçº¿ç¨‹æ‰§è¡Œä»»åŠ¡"><a href="#Workerçº¿ç¨‹æ‰§è¡Œä»»åŠ¡" class="headerlink" title="Workerçº¿ç¨‹æ‰§è¡Œä»»åŠ¡"></a>Workerçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</h3><p>  åœ¨Workerç±»ä¸­çš„runæ–¹æ³•è°ƒç”¨äº†runWorkeræ–¹æ³•æ¥æ‰§è¡Œä»»åŠ¡ï¼ŒrunWorkeræ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code> 1.whileå¾ªç¯ä¸æ–­åœ°é€šè¿‡getTask()æ–¹æ³•è·å–ä»»åŠ¡ã€‚
</code></pre>
<p>â€‹	 2.getTask()æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ã€‚</p>
<pre><code> 3.å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼Œé‚£ä¹ˆè¦ä¿è¯å½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œå¦åˆ™è¦ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ã€‚

 4.æ‰§è¡Œä»»åŠ¡ã€‚

 5.å¦‚æœgetTaskç»“æœä¸ºnullåˆ™è·³å‡ºå¾ªç¯ï¼Œæ‰§è¡ŒprocessWorkerExit()æ–¹æ³•ï¼Œé”€æ¯çº¿ç¨‹ã€‚
</code></pre>
<p>  æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>  <img src="/.io//879edb4f06043d76cea27a3ff358cb1d45243.png" alt="å›¾11 æ‰§è¡Œä»»åŠ¡æµç¨‹"></p>
<h2 id="å¼‚æ­¥è®¡ç®—ç»“æœ"><a href="#å¼‚æ­¥è®¡ç®—ç»“æœ" class="headerlink" title="å¼‚æ­¥è®¡ç®—ç»“æœ"></a>å¼‚æ­¥è®¡ç®—ç»“æœ</h2><p><strong><code>Future</code></strong> æ¥å£ä»¥åŠ <code>Future</code> æ¥å£çš„å®ç°ç±» <strong><code>FutureTask</code></strong> ç±»éƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚</p>
<p>æŠŠ <strong><code>Runnable</code>æ¥å£</strong> æˆ– <strong><code>Callable</code> æ¥å£</strong> çš„å®ç°ç±»æäº¤ç»™ <strong><code>ThreadPoolExecutor</code></strong> æˆ– <strong><code>ScheduledThreadPoolExecutor</code></strong> æ‰§è¡Œã€‚ï¼ˆè°ƒç”¨ <code>submit()</code> æ–¹æ³•æ—¶ä¼šè¿”å›ä¸€ä¸ª <strong><code>FutureTask</code></strong> å¯¹è±¡ï¼‰</p>
<p><strong><code>Executor</code> æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾</strong>ï¼š</p>
<p><img src="/.io//Executor%E6%A1%86%E6%9E%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A4%BA%E6%84%8F%E5%9B%BE-36e59afa.png" alt="Executor æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾"></p>
<ol>
<li>ä¸»çº¿ç¨‹é¦–å…ˆè¦åˆ›å»ºå®ç° <code>Runnable</code> æˆ–è€… <code>Callable</code> æ¥å£çš„ä»»åŠ¡å¯¹è±¡ã€‚</li>
<li>æŠŠåˆ›å»ºå®Œæˆçš„å®ç° <code>Runnable</code>&#x2F;<code>Callable</code>æ¥å£çš„ å¯¹è±¡ç›´æ¥äº¤ç»™ <code>ExecutorService</code> æ‰§è¡Œ: ExecutorService.executeï¼ˆRunnable commandï¼‰æˆ–è€…ä¹Ÿå¯ä»¥æŠŠ <code>Runnable</code> å¯¹è±¡æˆ–<code>Callable</code> å¯¹è±¡æäº¤ç»™ <code>ExecutorService</code> æ‰§è¡Œï¼ˆ<code>ExecutorService.submitï¼ˆRunnable taskï¼‰</code>æˆ– <code>ExecutorService.submitï¼ˆCallable &lt;T&gt; taskï¼‰</code>ï¼‰ã€‚</li>
<li>å¦‚æœæ‰§è¡Œ <code>ExecutorService.submitï¼ˆâ€¦ï¼‰</code>ï¼Œ<code>ExecutorService</code> å°†è¿”å›ä¸€ä¸ªå®ç°<code>Future</code>æ¥å£çš„å¯¹è±¡ï¼ˆåˆšåˆšä¹Ÿæåˆ°è¿‡äº†æ‰§è¡Œ <code>execute()</code>æ–¹æ³•å’Œ <code>submit()</code>æ–¹æ³•çš„åŒºåˆ«ï¼Œ<code>submit()</code>ä¼šè¿”å›ä¸€ä¸ª <code>FutureTask å¯¹è±¡ï¼‰ã€‚ç”±äº FutureTask</code> å®ç°äº† <code>Runnable</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»º <code>FutureTask</code>ï¼Œç„¶åç›´æ¥äº¤ç»™ <code>ExecutorService</code> æ‰§è¡Œã€‚</li>
<li>æœ€åï¼Œä¸»çº¿ç¨‹å¯ä»¥æ‰§è¡Œ <code>FutureTask.get()</code>æ–¹æ³•æ¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰§è¡Œ <code>FutureTask.cancelï¼ˆboolean mayInterruptIfRunningï¼‰</code>æ¥å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚</li>
</ol>
<h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html">çº¿ç¨‹æ± åº”ç”¨</a></p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="executeæ–¹æ³•"><a href="#executeæ–¹æ³•" class="headerlink" title="executeæ–¹æ³•"></a>executeæ–¹æ³•</h3><h4 id="ä¼ªä»£ç "><a href="#ä¼ªä»£ç " class="headerlink" title="ä¼ªä»£ç "></a>ä¼ªä»£ç </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">Runnable command</span>):</span><br><span class="line">    <span class="keyword">if</span> command == null :</span><br><span class="line">        æŠ›å¼‚å¸¸</span><br><span class="line">    <span class="keyword">if</span> å½“å‰å·¥ä½œçº¿ç¨‹æ•° &lt; æ ¸å¿ƒçº¿ç¨‹æ•°:</span><br><span class="line">        <span class="keyword">if</span> addWorker(command,true):</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> çº¿ç¨‹æ± å¤„äºRunningçŠ¶æ€ &amp;&amp; å°†commandåŠ å…¥é˜Ÿåˆ—æˆåŠŸ:</span><br><span class="line">        <span class="keyword">if</span> å†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± ä¸å¤„äºRunningçŠ¶æ€ &amp;&amp; é˜Ÿåˆ—ç§»é™¤commandæˆåŠŸ:</span><br><span class="line">            reject(command)</span><br><span class="line">        <span class="keyword">elif</span> å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º<span class="number">0</span>:</span><br><span class="line">            addWorker(null,false)</span><br><span class="line">    <span class="keyword">elif</span> !addWorker(command,false):</span><br><span class="line">        reject(command)</span><br></pre></td></tr></table></figure>

<h4 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">//ctl ä¸­ä¿å­˜çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();    </span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡çš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å¤„äºRunningçŠ¶æ€ä¸”å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—æˆåŠŸ</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    å¦‚æœä¸€ä¸ªä»»åŠ¡å¯ä»¥æˆåŠŸæ’é˜Ÿï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»ç„¶éœ€è¦ä»”ç»†æ£€æŸ¥æ˜¯å¦åº”è¯¥æ·»åŠ ä¸€ä¸ªçº¿ç¨‹(å› ä¸ºè‡ªä¸Šæ¬¡æ£€æŸ¥ä»¥æ¥å·²æœ‰çš„çº¿ç¨‹å·²ç»æ­»äº¡)ï¼Œ	æˆ–è€…çº¿ç¨‹æ± åœ¨è¿›å…¥è¯¥æ–¹æ³•åå…³é—­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é‡æ–°æ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœåœæ­¢æ—¶å¦‚æœæœ‰å¿…è¦ï¼Œå›æ»šé˜Ÿåˆ—ï¼›æˆ–è€…å¦‚æœæ²¡æœ‰å·¥ä½œçº¿ç¨‹åˆ›å»º		ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œæ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¦‚æœçº¿ç¨‹æ± ä¸åœ¨RunningçŠ¶æ€æˆ–è¾¾åˆ°é˜»å¡é˜Ÿåˆ—æœ€å¤§å®¹é‡-&gt;åœ¨ä¿è¯çº¿ç¨‹æ•°é‡æœªè¾¾åˆ°åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        <span class="comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œå°±æ‰§è¡Œæ‹’ç»ç­–ç•¥</span></span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="submitæ–¹æ³•"><a href="#submitæ–¹æ³•" class="headerlink" title="submitæ–¹æ³•"></a>submitæ–¹æ³•</h3><h4 id="ä¼ªä»£ç -1"><a href="#ä¼ªä»£ç -1" class="headerlink" title="ä¼ªä»£ç "></a>ä¼ªä»£ç </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">å‚æ•°åˆ—è¡¨</span>):</span><br><span class="line">    <span class="keyword">if</span> ä»»åŠ¡==null:</span><br><span class="line">        æŠ›å¼‚å¸¸</span><br><span class="line">    å°è£…ä¸ºRunnableFutureå¯¹è±¡ftask</span><br><span class="line">    execute(ftask)</span><br><span class="line">    <span class="keyword">return</span> ftask</span><br></pre></td></tr></table></figure>

<h4 id="æºç -1"><a href="#æºç -1" class="headerlink" title="æºç "></a>æºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="literal">null</span>);</span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Runnable task, T result)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="comment">//AbstractExecutorServiceç±»    </span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Runnable runnable, T value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(runnable, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Callable&lt;T&gt; callable)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(callable);</span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="execute-vssubmit"><a href="#execute-vssubmit" class="headerlink" title="execute()vssubmit()"></a>execute()<code>vs</code>submit()</h3><ul>
<li><code>execute()</code>æ–¹æ³•ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸä¸å¦ï¼›</li>
<li><code>submit()</code>æ–¹æ³•ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ª <code>Future</code> ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª <code>Future</code> å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <code>Future</code> çš„ <code>get()</code>æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œ<code>get()</code>æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨ <code>getï¼ˆlong timeoutï¼ŒTimeUnit unitï¼‰</code>æ–¹æ³•çš„è¯ï¼Œå¦‚æœåœ¨ <code>timeout</code> æ—¶é—´å†…ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå°±ä¼šæŠ›å‡º <code>java.util.concurrent.TimeoutException</code>ã€‚</li>
</ul>
<h2 id="addWorkeræ–¹æ³•"><a href="#addWorkeræ–¹æ³•" class="headerlink" title="addWorkeræ–¹æ³•"></a>addWorkeræ–¹æ³•</h2><h3 id="ä¼ªä»£ç -2"><a href="#ä¼ªä»£ç -2" class="headerlink" title="ä¼ªä»£ç "></a>ä¼ªä»£ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="æºç -2"><a href="#æºç -2" class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªæ ‡è®°, ç±»ä¼¼ goto, è‡ªè¡Œäº†è§£ï¼Œç»“åˆä¸‹é¢çš„ break å’Œ continue å°±èƒ½æ˜ç™½ä»€ä¹ˆæ„æ€</span></span><br><span class="line">    retry:</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€éƒ¨åˆ†</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å› false è¡¨ç¤ºæ— æ³•æ¥æ”¶æˆ–å¤„ç†ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸æƒ³è¿”å› falseï¼Œä¹Ÿå°±æ˜¯ if è¯­å¥åˆ¤æ–­ä¸æˆç«‹ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼š</span></span><br><span class="line">        <span class="comment">// 1. rs &lt; SHUTDOWN, ä¹Ÿå°±æ˜¯ rs == RUNNINGï¼ˆæˆ‘ä»¬ä¹‹å‰è®²è¿‡ RUNNING è¡¨ç¤ºå¯ä»¥æ¥å—æ–°çš„ä»»åŠ¡ï¼‰</span></span><br><span class="line">        <span class="comment">// 2. rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty()</span></span><br><span class="line">        <span class="comment">// 	2.1 rs == SHUTDOWN è¡¨ç¤ºä¸ä¼šæ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šæ‰§è¡Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// 	2.2 firstTask == nul è¡¨ç¤ºè¦æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// 	2.3 é˜»å¡é˜Ÿåˆ—ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span> &amp;&amp;  ! workQueue.isEmpty())</span><br><span class="line">           )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ•°é‡å¤§äºæœ€å¤§å®¹é‡(CAPACITY), ç›´æ¥è¿”å› false</span></span><br><span class="line">            <span class="comment">// å¦‚æœ core == true ï¼Œå°±åˆ¤æ–­çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="comment">// å¦‚æœ core == false, å°±åˆ¤æ–­çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äºæœ€å¤§çº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é€šè¿‡ CAS æ“ä½œ, æŠŠçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ + 1ï¼Œç„¶åè·³å‡ºåŒå±‚å¾ªç¯ï¼Œè¿›å…¥ç¬¬äºŒéƒ¨åˆ†</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// CAS æ“ä½œå¤±è´¥ï¼Œå°±æ ¸å¯¹çº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line">            c = ctl.get(); </span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="comment">// ç»§ç»­ä»æœ€å¤–å±‚å¾ªç¯å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬äºŒéƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">// èµ°åˆ°è¿™é‡Œï¼Œè¡¨ç¤ºçº¿ç¨‹æ± å¯ä»¥åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œæˆ–è€…å¯ä»¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">    <span class="comment">// ä¸¤ä¸ªæ ‡è®°ï¼Œè§åçŸ¥ä¹‰</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸‹é¢ä¸¤è¡Œä»£ç ä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç» Worker å¯¹è±¡æ—¶ï¼Œè¯¦ç»†è¯´æ˜è¿‡</span></span><br><span class="line">        <span class="comment">// åŒ…è£…éœ€è¦æ‰§è¡Œä»»åŠ¡ï¼ˆæ³¨æ„ firstTask å¯èƒ½ä¸º nullï¼‰</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æ‰¿è½½ä»»åŠ¡çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šé”</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line">                <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸º RUNNING</span></span><br><span class="line">                <span class="comment">// æˆ–è€…</span></span><br><span class="line">                <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN ä¸” firstTask == nullï¼Œ</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||  (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) </span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ·»åŠ è‡³ workers é›†åˆ</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    <span class="comment">// æ·»åŠ æˆåŠŸ</span></span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹å¯åŠ¨å¤±è´¥, å°±åˆ é™¤ workers é›†åˆä¸­åˆšæ·»åŠ çš„ Worker å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ jaytp@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">ğŸ’°</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    Â©2016-2020 Yelog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="åˆ‡æ¢å…¨å± å¿«æ·é”® s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">Ã—</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="æ‰«ç æ”¯æŒ">
            <img src="/img/weixin.jpg" class="weixin" title="æ‰«ç æ”¯æŒ">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    

    
</style>







</html>
